name: Build UA3F Package

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment and build UA3F
      run: |
        # Install dependencies
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-setuptools rsync unzip zlib1g-dev file wget
        
        # Clone ImmortalWrt source (使用更稳定的方式)
        git clone https://github.com/immortalwrt/immortalwrt.git --depth=1
        cd immortalwrt
        
        # 使用正确的分支（尝试多个可能的分支名称）
        git checkout openwrt-24.10 || git checkout v24.10.0 || git checkout main
        
        # Update feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # Add UA3F
        git clone https://github.com/SunBK201/UA3F.git package/UA3F
        
        # Configure for x86_64 (简化配置)
        cat > .config << 'EOF'
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_Generic=y
CONFIG_PACKAGE_ua3f=y
EOF
        
        # Build UA3F package only
        make defconfig
        echo "开始编译 UA3F..."
        make package/UA3F/compile -j2 V=s
        
        # List generated files
        echo "=== Build completed, generated files ==="
        find bin/packages -name "ua3f*.ipk" -type f || echo "未找到 ua3f 包文件"
        
    - name: Upload IPK files
      uses: actions/upload-artifact@v4
      with:
        name: ua3f-packages
        path: immortalwrt/bin/packages/**/ua3f*.ipk
        retention-days: 7
      if: success()
